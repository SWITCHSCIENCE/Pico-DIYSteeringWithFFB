# Pico-DIYSteeringWithFFB

## 必要なもの

### パーツ類

https://www.switch-science.com/products/6900
<blockquote class="blogcard" style="width:auto;border:1px solid #aaa;margin:1em 0;padding:1em;line-height:1.4;text-align:left;background:#fff;"><a href="https://www.switch-science.com/products/6900" target="_blank" style="display:block;text-decoration:none;"><div style="width:100%;margin:0 0 .5em;"><span style="font-size:18px;font-weight:700;color:#333">Raspberry Pi Pico</span></div><div style="min-height:100px;"><div style="float:left;width:100px;height:100px;margin:0 .5em;position:relative;"><img src="https://images.weserv.nl/?w=100&url=https://cdn.shopify.com/s/files/1/0514/0719/2262/products/eacb998e-6884-4f33-bec7-31c1b0b382b4_d554b388-fad1-49f1-96bb-dcb7ce49d9e1_1200x1200.jpg?v=1672016455" alt="thumbnail" style="display:block;margin:0;padding:0;width:100%;height:auto;border:none;position:absolute;top:50%;transform:translateY(-50%);"/></div><div style="padding:0 .5em;overflow:hidden;text-overflow:ellipsis;"><span style="font-size:14px;font-weight:400;color:#666">Raspberry Pi財団が独自に開発したARM Cortex M0+デュアルコアのRP2040マイコンを搭載した開発基板です。C/C++およびMicroPythonで開発が可能です。既存のRaspberry Piとは異なりLinux OSは搭載できませんのでご注意ください。</span><br/><span style="font-size:12px;font-weight:400;color:#373">https://www.switch-science.com/products/6900</span></div></div></a></blockquote>

https://www.switch-science.com/catalog/8248/
<blockquote class="blogcard" style="width:auto;border:1px solid #aaa;margin:1em 0;padding:1em;line-height:1.4;text-align:left;background:#fff;"><a href="https://www.switch-science.com/products/9219" target="_blank" style="display:block;text-decoration:none;"><div style="width:100%;margin:0 0 .5em;"><span style="font-size:18px;font-weight:700;color:#333">DDT M1502D_211 タイヤ付きダイレクトドライブモーター  24V/9.6Nm/115rpm</span></div><div style="min-height:100px;"><div style="float:left;width:100px;height:100px;margin:0 .5em;position:relative;"><img src="https://images.weserv.nl/?w=100&url=https://cdn.shopify.com/s/files/1/0514/0719/2262/products/1f7b6144-3c5f-4dd6-8ce2-04e0d9c8145b_f0c2efc5-9f40-47a3-ae85-80c630a75ce8_1200x800.jpg?v=1672016471" alt="thumbnail" style="display:block;margin:0;padding:0;width:100%;height:auto;border:none;position:absolute;top:50%;transform:translateY(-50%);"/></div><div style="padding:0 .5em;overflow:hidden;text-overflow:ellipsis;"><span style="font-size:14px;font-weight:400;color:#666">高トルク、静音、高精度が特徴のタイヤ付きの永久磁石同期モーターです。サーボモーター、エンコーダ、ブラシレスモーターとして使用することができます。</span><br/><span style="font-size:12px;font-weight:400;color:#373">https://www.switch-science.com/products/9219</span></div></div></a></blockquote>

https://amzn.asia/d/b9DWvV3
<blockquote class="blogcard" style="width:auto;border:1px solid #aaa;margin:1em 0;padding:1em;line-height:1.4;text-align:left;background:#fff;"><a href="https://amzn.asia/d/6fEEtIi" target="_blank" style="display:block;text-decoration:none;"><div style="width:100%;margin:0 0 .5em;"><span style="font-size:18px;font-weight:700;color:#333">WINGONEER MCP2515 CANバスモジュールTJA1050レシーバSPIモジュール</span></div><div style="min-height:100px;"><div style="float:left;width:100px;height:100px;margin:0 .5em;position:relative;"><img src="https://images.weserv.nl/?w=100&url=https://m.media-amazon.com/images/I/61uc63Aq2mL._AC_SL1200_.jpg" alt="thumbnail" style="display:block;margin:0;padding:0;width:100%;height:auto;border:none;position:absolute;top:50%;transform:translateY(-50%);"/></div><div style="padding:0 .5em;overflow:hidden;text-overflow:ellipsis;"><span style="font-size:14px;font-weight:400;color:#666">サポートCAN V2.0B仕様、通信速度1Mb / S
0〜8バイトのデータフィールド
標準フレームとフレームとリモートフレームを展開
5V DC電源モジュール、SPIインタフェースプロトコル制御
120オームの終端抵抗。 インピーダンスマッチング、ドライブ容量、信号線に対する長距離データ伝送を保証</span><br/><span style="font-size:12px;font-weight:400;color:#373">https://amzn.asia/d/6fEEtIi</span></div></div></a></blockquote>

https://www.amazon.co.jp/gp/product/B09PRD74V4
<blockquote class="blogcard" style="width:auto;border:1px solid #aaa;margin:1em 0;padding:1em;line-height:1.4;text-align:left;background:#fff;"><a href="https://www.amazon.co.jp/gp/product/B09PRD74V4" target="_blank" style="display:block;text-decoration:none;"><div style="width:100%;margin:0 0 .5em;"><span style="font-size:18px;font-weight:700;color:#333">DROK スイッチング電源 24VDC20A 480W</span></div><div style="min-height:100px;"><div style="float:left;width:100px;height:100px;margin:0 .5em;position:relative;"><img src="https://images.weserv.nl/?w=100&url=https://m.media-amazon.com/images/I/71gSvsp8RpL._AC_SL1500_.jpg" alt="thumbnail" style="display:block;margin:0;padding:0;width:100%;height:auto;border:none;position:absolute;top:50%;transform:translateY(-50%);"/></div><div style="padding:0 .5em;overflow:hidden;text-overflow:ellipsis;"><span style="font-size:14px;font-weight:400;color:#666">AC 110/220V→DC 0-24V 0-20A 480W 電圧電流調整可能 安定化電源</span><br/><span style="font-size:12px;font-weight:400;color:#373">https://www.amazon.co.jp/gp/product/B09PRD74V4</span></div></div></a></blockquote>



### 筐体関連

- 実車用ハンドル(例：https://www.amazon.co.jp/gp/product/B09DYL19KQ)
<blockquote class="blogcard" style="width:auto;border:1px solid #aaa;margin:1em 0;padding:1em;line-height:1.4;text-align:left;background:#fff;"><a href="https://www.amazon.co.jp/gp/product/B09DYL19KQ" target="_blank" style="display:block;text-decoration:none;"><div style="width:100%;margin:0 0 .5em;"><span style="font-size:18px;font-weight:700;color:#333">ステアリング 35φ 車用 カー ハンドル ディープコーン 直径350mm</span></div><div style="min-height:100px;"><div style="float:left;width:100px;height:100px;margin:0 .5em;position:relative;"><img src="https://images.weserv.nl/?w=100&url=https://m.media-amazon.com/images/I/71FcClOg8mL._AC_SL1500_.jpg" alt="thumbnail" style="display:block;margin:0;padding:0;width:100%;height:auto;border:none;position:absolute;top:50%;transform:translateY(-50%);"/></div><div style="padding:0 .5em;overflow:hidden;text-overflow:ellipsis;"><span style="font-size:14px;font-weight:400;color:#666">ブラックスポーク スポーツタイプ 軽量アルミニウム ライチ柄 ステアリングホイール PVC防錆 車用 ホーンボタン付き/黒</span><br/><span style="font-size:12px;font-weight:400;color:#373">https://www.amazon.co.jp/gp/product/B09DYL19KQ</span></div></div></a></blockquote>

- ハンドル固定プレート（3Dプリント）
- ハンドルとハンドル固定プレートを留めるワッシャとナット（M4 x 8セット）
- モーター固定アングル（3Dプリント、耐熱60度程度が必要でABS推奨）
- 固定用の板（450x250x15mmの木材など）
- 板と電源を固定するネジ（M3-20mm x 4本）
- 板とモーター固定アングルを固定するボルト＆ナット（M5-30mm x 4本）
- 板を机に固定するためのクランプ（50mm x 2本）

ハンドル固定プレートとモーターを固定するネジはモーターに付属のものを利用。
ハンドルとハンドル固定プレートを固定するボルトはハンドルに付属のものを利用。

## 結線

電源ユニット
|ラベル|接続先|
|--|--|
|+V|モーター(赤)|
|-V|モーター(黒)|
|アース|ACコンセント|
|N|ACコンセント|
|L|ACコンセント|

モーター（４芯ケーブル）

|番号|役割|色|接続先|
|--|--|--|--|
|1|VCC(24V)|赤|電源ユニット|
|2|GND|黒|電源ユニット|
|3|CAN High|黄|CANアダプタ(H)|
|4|CAN Low|白|CANアダプタ(L)|


PICOとCANアダプタ間
|信号名|Picoピン名|MCPピン名|
|--|--|--|
|unuse|-|1:INT|
|SCK|GP2|2:SCK|
|SDO|GP3|3:MOSI|
|SDI|GP4|4:MISO|
|GP28|CS|5:CS|
|GND|GND|6:GND|
|3.3V|3.3V|7:VCC|
 
## ファームウェア開発環境

- TinyGo(dev版 または version 0.27以降)
- Go(1.19以降)

## ソースコード

[ファームウェアおよび3Dプリントモデルのソースコード公開URL(GitHub)](https://github.com/SWITCHSCIENCE/Pico-DIYSteeringWithFFB)

### ビルド

ソースのクローン
```
git clone https://github.com/SWITCHSCIENCE/Pico-DIYSteeringWithFFB
cd Pico-DIYSteeringWithFFB
cd firmware
```

ビルド
```
docker compose up build
```

正常にビルドできた場合、`build/Pico-DIYSteeringWithFFB.uf2`が出力されます。

### 書き込み

「BOOT SEL」ボタンを押しながらPicoをPCに繋ぎます。
「RPI-PICO」という名称のドライブが見えたらそこに「Pico-DIYSteeringWithFFB.uf2」をドラッグ＆ドロップします。

## 動作テスト

- 電源が24V出力になるよう調整、カレントリミッタはMAX寄り（最大から少し戻す程度）
- 電源をコンセントに繋いだ状態でPICOのUSBをPCに繋ぐ

状況によっては「ガツッ」とか言うかもしれませんが、センターにて落ち着くのを確認しましょう。

以下を開いて、ステアリング操作が反映されることを確認しましょう。

[Webゲームコントローラーテスト](https://luser.github.io/gamepadtest/)

